<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project>
<project name="CSWeb" default="deploy" basedir="..">

	<property name="build.output" value="output" />
	<property name="venv.python" value="/usr/local/TeamCityBuildAgent/work/venv/bin/python" />

	<target name="clean">
		<delete dir="${build.output}" quiet="true" />
	</target>

	<target name="copy">
		<copy todir="${build.output}/app">
			<fileset dir="app"/>
		</copy>
		<copy todir="${build.output}/data">
			<fileset dir="data"/>
		</copy>
		<copy todir="${build.output}/utils">
			<fileset dir="utils"/>
		</copy>
		<copy file="run_test.py" todir="${build.output}"/>
		<copy file="run_prod.py" todir="${build.output}"/>
    </target>

    <target name="compile">
       <exec dir="${build.output}" executable="${venv.python}" failonerror="true">
	       <arg line="-m compileall ." />
       </exec>
    </target>

	<target name="upload">
		<exec dir="${build.output}" executable="rsync" failonerror="true">
			<arg value="-vazHAX" />
            <arg value="--dry-run" />
            <arg value="--exclude-from=${build.output}/build/exclude.txt" />
			<arg value="--delete-during" />
			<arg value="-e ssh -i ${upload.credentials}" />
			<arg value="." />
			<arg value="${upload.destination}" />
		</exec>
		<exec dir="${build.output}/app/static" executable="rsync" failonerror="true">
			<arg value="-vazHAX" />
            <arg value="--dry-run" />
			<arg value="-e ssh -i ${upload.credentials}" />
			<arg value="." />
			<arg value="${upload.destination}/app/static" />
		</exec>
	</target>

    <target name="restart">
       <exec dir="${build.output}" executable="ssh" failonerror="true">
           <arg line="-i ${upload.credentials} ${upload.user} sudo service uwsgi restart"/>
       </exec>
    </target>

	<target name="deploy" depends="clean,copy,compile,upload,restart" />

</project>
