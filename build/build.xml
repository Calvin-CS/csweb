<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE project>
<project name="CSWeb" default="build" basedir="..">

	<property name="application.name" value="csweb" />

	<property name="build.number" value="0.0.0.0" />
	<property name="build.output" value="output" />
	<property name="build.packageFile" value="${build.output}/${application.name}.tgz" />

	<property name="build.uploadPath" value="${build.output}/package/htdocs" />

	<target name="clean">
		<delete dir="${build.output}" quiet="true" />
	</target>
		
	<target name="upload-clean" depends="">
		<delete dir="${build.uploadPath}" quiet="true" />
	</target>

	<target name="version">
		<property name="version" value="${build.number}" />
		<echo>${version}</echo>
	</target>
	
	<target name="build-prepare">
		<mkdir dir="${build.output}" />
	</target>

	<target name="build" />

	<target name="test-python" depends="">
		<exec dir="test" executable="python">
			<arg value="-m" />
			<arg value="unittest" />
			<arg file="run_test" />
		</exec>
	</target>

	<target name="test">
		<antcall target="test-python" />
	</target>
	
	<target name="package-copyWeb" depends="build-prepare,version">
		<copy todir="${build.uploadPath}">
			<fileset dir="app"/>
			<fileset dir="data"/>
			<fileset dir="utils"/>
			<!-- what about run_*.py ??? -->
		</copy>

		<chgrp type="both" group="www-data">
			<dirset dir="${build.uploadPath}" />
			<fileset dir="${build.uploadPath}" >
			    <include name="**/*"/>
			</fileset>
		</chgrp>
	</target>
	
	<target name="package" depends="clean,build-prepare,package-copyWeb" >
		<tar 
			destfile="${build.packageFile}"
			basedir="${build.output}/package"
			excludes="${build.packageFile}"
			longfile="gnu"
			compression="gzip" />
	</target>
	
	<target name="upload" depends="package,upload-clean">
		<exec dir="${build.uploadPath}" executable="rsync" failonerror="true">
			<arg value="-vazHAX" />
			<arg value="--delete-during" />
			<arg value='--rsh=ssh -i ${upload.credentials}' />
			<arg value="${build.uploadPath}/" />
			<arg value="${upload.destination}" />
		</exec>
	</target>
	
</project>

